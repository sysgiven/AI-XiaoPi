# å°çš®AIç›´æ’­æœºå™¨äºº æ™ºèƒ½ç¡¬ä»¶+ç§æœ‰æœåŠ¡å™¨è§£å†³æ–¹æ¡ˆ (XiaoPi)

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)

> ä¸€ä¸ªåŸºäº xiaozhi-esp32å’Œxiaozhi-esp32-server å¼€å‘çš„AIç›´æ’­æœºå™¨äººï¼Œè®©ä½ çš„AIç¡¬ä»¶è®¾å¤‡èƒ½å¤Ÿå®æ—¶å“åº”ç›´æ’­é—´å¼¹å¹•ã€‚

## ğŸ“– é¡¹ç›®ç®€ä»‹

å°çš®AIç›´æ’­æœºå™¨äºº(XiaoPi)æ˜¯ä¸€ä¸ªå°†ç›´æ’­å¼¹å¹•ä¸AIç¡¬ä»¶è¯­éŸ³äº¤äº’ç»“åˆçš„è§£å†³æ–¹æ¡ˆã€‚å®ƒèƒ½å¤Ÿï¼š

- ğŸ“º å®æ—¶æ¥æ”¶ç›´æ’­é—´å¼¹å¹•æ¶ˆæ¯
- ğŸ¤– ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹(LLM)ç”Ÿæˆæ™ºèƒ½å›å¤
- ğŸ”Š å°†å›å¤è½¬æ¢ä¸ºè¯­éŸ³(TTS)
- ğŸ“¡ å‘é€åˆ°ESP32ç­‰ç¡¬ä»¶è®¾å¤‡è¿›è¡Œæ’­æ”¾
- ğŸ¯ æ”¯æŒä¸²è¡ŒåŒ–å¤„ç†ï¼Œé¿å…å¼¹å¹•å †ç§¯

[æ¼”ç¤º+ä»£ç æµç¨‹] (https://www.bilibili.com/video/BV1sDqEBQESd/?vd_source=12f6d76610175d37664858167b4e567a)

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

- **å¤šç§å¼¹å¹•é‡‡é›†æ¨¡å¼**
  - æ¨¡æ‹Ÿæ¨¡å¼ï¼šç”¨äºå¼€å‘æµ‹è¯•
  - ä»£ç†æ¨¡å¼ï¼šé€šè¿‡ DouyinBarrageGrab è·å–çœŸå®å¼¹å¹•ï¼ˆæ¨èï¼‰
  - ç›´è¿æ¨¡å¼ï¼šç›´æ¥è¿æ¥ï¼ˆéœ€è‡ªè¡Œå®ç°ï¼‰

- **æ™ºèƒ½æµé‡æ§åˆ¶**
  - ä¸²è¡ŒåŒ–å¤„ç†ï¼šä¸€æ¬¡åªå¤„ç†ä¸€æ¡å¼¹å¹•
  - è‡ªåŠ¨å¿½ç•¥ä¸­é—´å¼¹å¹•ï¼šåªå“åº”æœ€æ–°çš„å¼¹å¹•
  - é˜²æ­¢éŸ³é¢‘å †ç§¯å’Œæ’­æ”¾æ··ä¹±

- **çµæ´»çš„AIé…ç½®**
  - æ”¯æŒå¤šç§LLMæä¾›å•†ï¼ˆOpenAI, ChatGLM, Geminiç­‰ï¼‰
  - æ”¯æŒå¤šç§TTSå¼•æ“ï¼ˆEdge TTS, é˜¿é‡Œäº‘ç­‰ï¼‰
  - å¯è‡ªå®šä¹‰AIè§’è‰²å’Œå›å¤é£æ ¼

- **ç¡¬ä»¶è®¾å¤‡æ”¯æŒ**
  - WebSocketè¿æ¥ç®¡ç†
  - è®¾å¤‡è‡ªåŠ¨å‘ç°å’Œå¿ƒè·³æ£€æµ‹
  - OTAå›ºä»¶æ›´æ–°æ¥å£

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.8+
- (å¯é€‰) ç›´æ’­é—´
- (å¯é€‰) ESP32ç¡¬ä»¶è®¾å¤‡

### å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
```bash
git clone <your-repo-url>
cd XiaoPi
```

2. **å®‰è£…ä¾èµ–**
```bash
cd xiaozhi-esp32-server/main/xiaozhi-server
pip install -r requirements.txt
```

3. **é…ç½®æœåŠ¡**

ç¼–è¾‘ `danmaku_config.yaml` æ–‡ä»¶ï¼š

```yaml
danmaku:
  # å¡«å†™ä½ çš„ç›´æ’­é—´IDï¼ˆå¦‚æœä½¿ç”¨çœŸå®å¼¹å¹•ï¼‰
  room_id: your_room_id

  # å·¥ä½œæ¨¡å¼é€‰æ‹©
  use_mock: false      # æ˜¯å¦ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
  use_proxy: true      # æ˜¯å¦ä½¿ç”¨ DouyinBarrageGrab ä»£ç†
  proxy_ws_url: "ws://127.0.0.1:8888"

# é…ç½®ä½ çš„LLMï¼ˆè¿™é‡Œä½¿ç”¨æ™ºè°±GLM-4-Flashï¼‰
LLM:
  ChatGLMLLM:
    api_key: your_api_key_here

# é…ç½®ä½ çš„TTSï¼ˆè¿™é‡Œä½¿ç”¨å…è´¹çš„Edge TTSï¼‰
TTS:
  EdgeTTS:
    voice: zh-CN-XiaoxiaoNeural
```

4. **å¯åŠ¨æœåŠ¡**

**Linux/macOS:**
```bash
./start_danmaku.sh
```

**Windows:**
```bash
start_danmaku.bat
```

æˆ–ç›´æ¥è¿è¡Œï¼š
```bash
python danmaku_app.py
```

### ä½¿ç”¨ DouyinBarrageGrabï¼ˆæ¨èï¼‰

å¦‚æœè¦è·å–çœŸå®çš„å¼¹å¹•ï¼Œéœ€è¦å…ˆå¯åŠ¨ DouyinBarrageGrabï¼š

1. è¿›å…¥ DouyinBarrageGrab ç›®å½•
2. è¿è¡Œå¼¹å¹•æŠ“å–æœåŠ¡ï¼ˆé»˜è®¤ç«¯å£ 8888ï¼‰
3. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ç›´æ’­é—´å¹¶è¿æ¥

è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ `DouyinBarrageGrab` ç›®å½•ä¸‹çš„ READMEã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
XiaoPi/
â”œâ”€â”€ xiaozhi-esp32-server/
â”‚   â””â”€â”€ main/
â”‚       â””â”€â”€ xiaozhi-server/
â”‚           â”œâ”€â”€ danmaku_app.py              # å¯åŠ¨å…¥å£
â”‚           â”œâ”€â”€ danmaku_config.yaml         # é…ç½®æ–‡ä»¶
â”‚           â”œâ”€â”€ start_danmaku.sh/bat        # å¯åŠ¨è„šæœ¬
â”‚           â””â”€â”€ danmaku_server/             # æ ¸å¿ƒæ¨¡å—
â”‚               â”œâ”€â”€ __init__.py
â”‚               â”œâ”€â”€ danmaku_service.py      # ä¸»æœåŠ¡
â”‚               â”œâ”€â”€ danmaku_handler.py      # å¼¹å¹•å¤„ç†å™¨
â”‚               â”œâ”€â”€ device_manager.py       # è®¾å¤‡ç®¡ç†
â”‚               â”œâ”€â”€ douyin_collector.py     # å¼¹å¹•é‡‡é›†
â”‚               â”œâ”€â”€ douyin_proxy_collector.py  # ä»£ç†æ¨¡å¼é‡‡é›†
â”‚               â””â”€â”€ danmaku_ota_handler.py  # OTAæ›´æ–°å¤„ç†
â”œâ”€â”€ DouyinBarrageGrab/                      # å¼¹å¹•æŠ“å–å·¥å…·
â””â”€â”€ docs/                                   # æ–‡æ¡£
```

## ğŸ”§ å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç›´æ’­é—´   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ å¼¹å¹•æ¶ˆæ¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DouyinBarrageGrab   â”‚ (å¯é€‰ä»£ç†)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ WebSocket
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Danmaku Collector   â”‚ å¼¹å¹•é‡‡é›†å™¨
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Danmaku Handler     â”‚ å¼¹å¹•å¤„ç†å™¨
â”‚  - ä¸²è¡ŒåŒ–å¤„ç†        â”‚
â”‚  - æµé‡æ§åˆ¶          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLM                 â”‚ ç”Ÿæˆå›å¤
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TTS                 â”‚ è½¬æ¢ä¸ºè¯­éŸ³
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device Manager      â”‚ è®¾å¤‡ç®¡ç†
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ WebSocket
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ESP32 ç¡¬ä»¶è®¾å¤‡       â”‚ æ’­æ”¾è¯­éŸ³
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ é…ç½®è¯´æ˜

### å¼¹å¹•æµé‡æ§åˆ¶

åœ¨å¼¹å¹•å¯†é›†çš„ç›´æ’­é—´ï¼Œå»ºè®®å¯ç”¨æµé‡æ§åˆ¶ï¼š

```yaml
danmaku:
  flow_control_enabled: true
  flow_control_strategy: skip  # æ¨èï¼šè·³è¿‡æ¨¡å¼
```

- `skip`: æ­£åœ¨æ’­æ”¾æ—¶ç›´æ¥ä¸¢å¼ƒæ–°å¼¹å¹•ï¼ˆæ¨èï¼Œä½“éªŒæœ€æµç•…ï¼‰
- `queue_limit`: é™åˆ¶å¾…å¤„ç†é˜Ÿåˆ—å¤§å°

### AIè§’è‰²é…ç½®

åœ¨ `danmaku_config.yaml` ä¸­è‡ªå®šä¹‰AIè§’è‰²ï¼š

```yaml
prompt: |
  ä½ æ˜¯ä¸€ä¸ªç›´æ’­é—´çš„AIåŠ©æ‰‹ï¼Œåå«å°çš®ã€‚
  å›å¤ç®€æ´æ˜å¿«ï¼Œæ¯æ¬¡å›å¤æ§åˆ¶åœ¨50å­—ä»¥å†…ã€‚
  è¯­æ°”æ´»æ³¼å‹å¥½ï¼Œé€‚åˆç›´æ’­é—´æ°›å›´ã€‚
```

### LLMæä¾›å•†

æ”¯æŒå¤šç§LLMæä¾›å•†ï¼Œé…ç½®ç¤ºä¾‹ï¼š

```yaml
selected_module:
  LLM: ChatGLMLLM  # æˆ– OpenAILLM, GeminiLLM ç­‰

LLM:
  ChatGLMLLM:
    type: openai
    model_name: glm-4-flash  # å…è´¹æ¨¡å‹
    api_key: your_api_key
```

### TTSå¼•æ“

æ”¯æŒå¤šç§TTSå¼•æ“ï¼Œé…ç½®ç¤ºä¾‹ï¼š

```yaml
selected_module:
  TTS: EdgeTTS  # æˆ– AliyunTTS, DoubaoTTS ç­‰

TTS:
  EdgeTTS:
    type: edge
    voice: zh-CN-XiaoxiaoNeural  # ä¸­æ–‡å¥³å£°
```

## ğŸ› æ•…éšœæ’é™¤

### éŸ³é¢‘ä¸æ’­æ”¾

å¦‚æœç¡¬ä»¶è®¾å¤‡ä¸æ’­æ”¾éŸ³é¢‘ï¼š
1. æ£€æŸ¥è®¾å¤‡æ˜¯å¦æ­£ç¡®è¿æ¥ï¼ˆWebSocketæ—¥å¿—ï¼‰
2. æŸ¥çœ‹ Rate Controller æ˜¯å¦å¯åŠ¨
3. ç¡®è®¤ `sentence_id` æ­£ç¡®è®¾ç½®ï¼ˆè¯¦è§ `SENTENCE_ID_FIX.md`ï¼‰

### å¼¹å¹•å¤„ç†å»¶è¿Ÿ

å¦‚æœå¼¹å¹•å¤„ç†å»¶è¿Ÿæˆ–å †ç§¯ï¼š
1. å¯ç”¨æµé‡æ§åˆ¶ï¼š`flow_control_enabled: true`
2. ä½¿ç”¨è·³è¿‡æ¨¡å¼ï¼š`flow_control_strategy: skip`
3. æ£€æŸ¥ LLM/TTS å“åº”æ—¶é—´

### DouyinBarrageGrab è¿æ¥å¤±è´¥

1. ç¡®è®¤ DouyinBarrageGrab å·²å¯åŠ¨
2. æ£€æŸ¥ WebSocket åœ°å€é…ç½®
3. æŸ¥çœ‹é˜²ç«å¢™è®¾ç½®

## ğŸ“š æ–‡æ¡£

- [æ¶æ„è¯´æ˜](xiaozhi-esp32-server/main/xiaozhi-server/ARCHITECTURE.md) - äº†è§£é¡¹ç›®æ¶æ„
- [å¼¹å¹•æ¥å…¥æŒ‡å—](xiaozhi-esp32-server/main/xiaozhi-server/DOUYIN_BARRAGE_SETUP.md) - é…ç½®å¼¹å¹•
- [ä¸²è¡ŒåŒ–å¤„ç†æ–¹æ¡ˆ](SERIALIZED_PROCESSING.md) - äº†è§£å¼¹å¹•å¤„ç†æœºåˆ¶
- [Sentence ID ä¿®å¤è¯´æ˜](SENTENCE_ID_FIX.md) - éŸ³é¢‘æ’­æ”¾é—®é¢˜ä¿®å¤

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

åœ¨æäº¤ PR å‰ï¼Œè¯·ç¡®ä¿ï¼š
- ä»£ç ç¬¦åˆé¡¹ç›®é£æ ¼
- æ·»åŠ å¿…è¦çš„æ³¨é‡Š
- æ›´æ–°ç›¸å…³æ–‡æ¡£

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº [MIT License](LICENSE) å¼€æºã€‚

## ğŸ™ è‡´è°¢

- [xiaozhi-esp32](https://github.com/78/xiaozhi-esp32) - ESP32ç¡¬ä»¶ç«¯å¼€æºé¡¹ç›®
- [xiaozhi-esp32-server](https://github.com/xinnan-tech/xiaozhi-esp32-server) - åç«¯æœåŠ¡åŸºç¡€æ¡†æ¶
- [DouyinBarrageGrab](https://github.com/IsoaSFlus/DouyinBarrageGrab) - å¼¹å¹•æŠ“å–
- æ‰€æœ‰è´¡çŒ®è€…å’Œç”¨æˆ·

## ğŸ“® è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- å¾®ä¿¡ px11360
- æäº¤ GitHub Issue
- å‘é€é‚®ä»¶è‡³ï¼š[sysgiven@gmail.com]
- åŠ å…¥è®¨è®ºç¾¤ï¼šæ·»åŠ å¾®ä¿¡åæ‹‰ç¾¤
---

â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç»™ä¸ª Starï¼
